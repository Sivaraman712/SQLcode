-- Step 1: Create a table to store parsed deadlock data
CREATE TABLE dbo.DeadlockReport (
    ID INT IDENTITY(1,1) PRIMARY KEY,
    EventTime DATETIME2(3),
    VictimProcessID NVARCHAR(100),
    VictimSPName NVARCHAR(200),
    VictimQuery NVARCHAR(MAX),
    WaiterProcessID NVARCHAR(100),
    WaiterSPName NVARCHAR(200),
    WaiterQuery NVARCHAR(MAX),
    LockedObject NVARCHAR(200),
    LockMode NVARCHAR(50),
    WaitType NVARCHAR(100),
    WaitDuration BIGINT,
    RawXML XML
);

-- Step 2: Extract and parse deadlock data from system_health .xel files
WITH DeadlockEvents AS (
    SELECT CAST(event_data AS XML) AS DeadlockXML,
           timestamp_utc AS EventTime
    FROM sys.fn_xe_file_target_read_file(
        'C:\Program Files\Microsoft SQL Server\MSSQLXX.MSSQLSERVER\MSSQL\Log\system_health*.xel',
        NULL, NULL, NULL)
    WHERE object_name = 'xml_deadlock_report'
),
Victim AS (
    SELECT 
        EventTime,
        DeadlockXML,
        V.value('@id', 'NVARCHAR(100)') AS VictimProcessID
    FROM DeadlockEvents
    CROSS APPLY DeadlockXML.nodes('/event/data/value/deadlock/victim-list/victim') AS VP(V)
),
Processes AS (
    SELECT 
        D.EventTime,
        V.VictimProcessID,
        P.value('@id', 'NVARCHAR(100)') AS ProcessID,
        P.value('(inputbuf)[1]', 'NVARCHAR(MAX)') AS InputBuf,
        F.value('@procname', 'NVARCHAR(200)') AS SPName,
        F.value('text()[1]', 'NVARCHAR(MAX)') AS FrameText,
        R.value('@objectname', 'NVARCHAR(200)') AS LockedObject,
        R.value('@mode', 'NVARCHAR(50)') AS LockMode,
        R.value('@waitType', 'NVARCHAR(100)') AS WaitType,
        R.value('@waitDuration', 'BIGINT') AS WaitDuration,
        D.DeadlockXML
    FROM Victim V
    JOIN DeadlockEvents D ON D.EventTime = V.EventTime
    CROSS APPLY D.DeadlockXML.nodes('/event/data/value/deadlock/process-list/process') AS PL(P)
    CROSS APPLY P.nodes('executionStack/frame') AS FS(F)
    OUTER APPLY D.DeadlockXML.nodes('/event/data/value/deadlock/resource-list/*') AS RL(R)
)
INSERT INTO dbo.DeadlockReport (
    EventTime, VictimProcessID, VictimSPName, VictimQuery,
    WaiterProcessID, WaiterSPName, WaiterQuery,
    LockedObject, LockMode, WaitType, WaitDuration, RawXML
)
SELECT 
    EventTime,
    VictimProcessID,
    CASE WHEN ProcessID = VictimProcessID THEN SPName ELSE NULL END,
    CASE WHEN ProcessID = VictimProcessID THEN InputBuf ELSE NULL END,
    CASE WHEN ProcessID <> VictimProcessID THEN ProcessID ELSE NULL END,
    CASE WHEN ProcessID <> VictimProcessID THEN SPName ELSE NULL END,
    CASE WHEN ProcessID <> VictimProcessID THEN InputBuf ELSE NULL END,
    LockedObject,
    LockMode,
    WaitType,
    WaitDuration,
    DeadlockXML
FROM Processes;
