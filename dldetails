WITH DeadlockEvents AS (
    SELECT 
        CAST(event_data AS XML) AS DeadlockXML,
        timestamp_utc AS EventTime
    FROM sys.fn_xe_file_target_read_file(
        'C:\...\system_health*.xel', NULL, NULL, NULL)
    WHERE object_name = 'xml_deadlock_report'
),
Victim AS (
    SELECT 
        EventTime,
        DeadlockXML,
        V.value('@id', 'NVARCHAR(100)') AS VictimProcessID
    FROM DeadlockEvents
    CROSS APPLY DeadlockXML.nodes('/event/data/value/deadlock/victim-list/victim') AS VP(V)
),
ProcessDetails AS (
    SELECT 
        D.EventTime,
        V.VictimProcessID,
        P.value('@id', 'NVARCHAR(100)') AS ProcessID,
        P.value('(inputbuf)[1]', 'NVARCHAR(MAX)') AS InputBuf,
        (
            SELECT STRING_AGG(F.value('@procname', 'NVARCHAR(200)'), ' -> ')
            FROM P.nodes('executionStack/frame') AS FS(F)
        ) AS SPCallChain,
        (
            SELECT TOP 1 F.value('text()[1]', 'NVARCHAR(MAX)')
            FROM P.nodes('executionStack/frame') AS FS(F)
            ORDER BY F.value('@line', 'INT') DESC
        ) AS FinalQuery,
        R.value('@objectname', 'NVARCHAR(200)') AS LockedObject,
        R.value('@mode', 'NVARCHAR(50)') AS LockMode,
        R.value('@waitType', 'NVARCHAR(100)') AS WaitType,
        R.value('@waitDuration', 'BIGINT') AS WaitDuration
    FROM Victim V
    JOIN DeadlockEvents D ON D.EventTime = V.EventTime
    CROSS APPLY D.DeadlockXML.nodes('/event/data/value/deadlock/process-list/process') AS PL(P)
    OUTER APPLY D.DeadlockXML.nodes('/event/data/value/deadlock/resource-list/*') AS RL(R)
),
FinalReport AS (
    SELECT 
        EventTime,
        MAX(CASE WHEN ProcessID = VictimProcessID THEN SPCallChain END) AS VictimSPChain,
        MAX(CASE WHEN ProcessID = VictimProcessID THEN InputBuf END) AS VictimQuery,
        MAX(CASE WHEN ProcessID = VictimProcessID THEN LockedObject END) AS VictimResource,
        MAX(CASE WHEN ProcessID = VictimProcessID THEN LockMode END) AS VictimLockMode,
        MAX(CASE WHEN ProcessID <> VictimProcessID THEN SPCallChain END) AS WaiterSPChain,
        MAX(CASE WHEN ProcessID <> VictimProcessID THEN InputBuf END) AS WaiterQuery,
        MAX(CASE WHEN ProcessID <> VictimProcessID THEN LockedObject END) AS WaiterResource,
        MAX(CASE WHEN ProcessID <> VictimProcessID THEN LockMode END) AS WaiterLockMode,
        MAX(CASE WHEN ProcessID <> VictimProcessID THEN WaitType END) AS WaitType,
        MAX(CASE WHEN ProcessID <> VictimProcessID THEN WaitDuration END) AS WaitDuration,
        MAX(D.DeadlockXML) AS DeadlockXML
    FROM ProcessDetails D
    GROUP BY EventTime
)
INSERT INTO dbo.DeadlockReport (
    EventTime, VictimSPChain, VictimQuery, VictimResource, VictimLockMode,
    WaiterSPChain, WaiterQuery, WaiterResource, WaiterLockMode,
    WaitType, WaitDuration, DeadlockXML
)
SELECT * FROM FinalReport;
